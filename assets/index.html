<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Olop App</title>
    <style>
        /* Styles CSS */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f8f8;
            transition: transform 0.3s ease;
        }

        * {
    transition: transform 0.3s ease;
}

        #sidebar {
            background-color: #ffffff;
            width: 250px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        #sidebar.hidden {
            transform: translateX(-250px);
        }

        #sidebar h1 {
            text-align: center;
            margin-top: 20px;
            color: #007bff;
        }

        #sidebar ul {
            list-style-type: none;
            padding: 0;
            margin: 20px 0;
        }

        #sidebar ul li {
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        #sidebar ul li:hover {
            background-color: #007bff;
            color: #ffffff;
        }

        #content {
            padding: 20px;
            padding-left: 50px;
            transition: margin-left 0.3s ease, transform 0.3s ease;
            margin-left: 0;
        }

        #clock {
            font-size: 20px;
            color: #000000;
            position: fixed;
            bottom: 10px;
            left: 20px;
            transition: left 0.3s ease, transform 0.3s ease;
        }

        #clock.open-left {
            right: 20px;
            transition: right 0.3s ease;
        }

        #loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        #toggleMenuBtn {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 999;
        }

        #toggleMenuBtn button {
            padding: 10px;
            border: none;
            border-radius: 20px;
            background-color: #ffffff;
            color: #007bff;
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
            cursor: pointer;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #toggleMenuBtn button:hover {
            background-color: #007bff;
            color: #ffffff;
        }

        #toggleMenuBtn button.closed {
            border-radius: 50%;
        }

        .notification-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .notification-container img {
            width: 100px;
            height: 100px;
            margin-bottom: 10px;
        }

        .notification-container p {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .notification-container button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: #ffffff;
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            outline: none;
            transition: background-color 0.3s ease;
        }

        .notification-container button:hover {
            background-color: #0056b3;
        }

        .window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .window-title {
            display: flex;
            align-items: center;
        }

        .window-icon {
            width: auto;
            height: 1em;
            margin-right: 0.5em;
        }

        .window-title-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-wrap: nowrap; /* Ajoutez cette ligne */
}
.window-title-bar span {
    font-size: 20px;
    font-weight: bold;
    word-wrap: break-word;
    flex-grow: 1; /* Ajoutez cette ligne */
}
.window-title-bar button {
    background-color: transparent;
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    color: #ffffff;
    font-family: Arial, sans-serif;
    font-size: 14px;
    font-weight: bold;
    text-transform: uppercase;
    cursor: pointer;
    outline: none;
    margin-left: 10px; /* Ajoutez cette ligne */
}

        .window-title-bar button:hover {
    transform: scale(1.3);
}

        .window-content {
            word-wrap: break-word;
        }

        .content-shifted {
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }

        .button {
            padding: 10px;
            border: none;
            border-radius: 20px;
            background-color: #ffffff;
            color: #007bff;
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
            transition: color 0.3s ease;
            cursor: pointer;
            outline: none;
        }

        .button:hover {
            background-color: #007bff;
            color: #ffffff;
        }

        .window-title-bar button.minimize-button {
            color: #000000;
        }

        .droite {
            float: right;
        }

        .flat-button {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    background-color: transparent;
    color: #007bff;
    font-family: Arial, sans-serif;
    font-size: 14px;
    font-weight: bold;
    text-transform: uppercase;
    cursor: pointer;
    outline: none;
    transition: background-color 0.3s ease, color 0.3s ease;
    text-decoration: none;  /* Ajoutez cette ligne */
}

.flat-button:hover {
    background-color: #007bff;
    color: #ffffff;
}

.flat-button.dark-theme {
    color: #ffffff;
}

.flat-button.dark-theme:hover {
    background-color: #ffffff;
    color: #007bff;
}

.settings-link {
    position: absolute;
    bottom: 35px; /* définir une marge de 20px par rapport au bas de la sidebar */
    left: 0;
    right: 0;
    padding: 10px;
    text-align: center;
}
        /* Themes de nuit */
        body.dark-theme {
    background-color: #242424;
    color: #ffffff;
}

#sidebar.dark-theme {
    background-color: #222222;
    color: #ffffff;
}

#content.dark-theme {
    background-color: #333333;
    color: #ffffff;
}

.window.dark-theme {
    background-color: #333333;
    color: #ffffff;
}

.window-title-bar.dark-theme {
    background-color: #444444;
    color: #ffffff;
}

#toggleMenuBtn .dark-theme {
    background-color: #444444;
    color: #ffffff;
}

.notification-container.dark-theme {
    background-color: #333333;
    color: #ffffff;
}

.button.dark-theme {
    background-color: #444444;
    color: #ffffff;
}

#clock.dark-theme {
    color: #ffffff;
}

.window-title-bar.dark-theme span {
    color: #ffffff;
}

.window-title-bar.dark-theme .minimize-button {
    color: #ffffff;
}

#toggleMenuBtn.dark-theme button {
    color: #ffffff;
    background-color: #333444;
}

a.dark-theme {
    color: yellow;
}

    </style>
    <script src="jquery.js"></script>
    <script src="Olop.js"></script>
    <script>
        // Variables
        var notificationCount = 0;
        var minimizedWindows = [];
        var minimizedWindowListRef;
        var isMinimizedWindowListOpen = false;
        var windowContentIds = [];
        var themeMode = 1;
        var FirstTATheme = 21;
        var secondTATheme = 8;

        function loadPage(page) {
            var loader = $("#loader");
            var content = $("#content");
            loader.show();
            content.hide();

            content.load(page + ".html", function(response, status, xhr) {
                loader.hide();
                if (status === "error") {
                    var errorMessage = "Erreur: " + xhr.status + " " + xhr.statusText;
                    showNotification(-1, "Erreur "+xhr.status, errorMessage);
                } else {
                    content.show();
                }
            });
        }

        // Afficher ou masquer le menu
        function toggleMenu() {
    var sidebar = document.getElementById("sidebar");
    var toggleButton = document.getElementById("toggleMenuBtn");
    var content = document.getElementById("content");
    var clock = document.getElementById("clock");

    sidebar.classList.toggle("hidden");
    toggleButton.classList.toggle("closed");
    clock.classList.toggle("open-left");

    content.style.marginLeft = sidebar.classList.contains("hidden") ? "0" : "250px";
}

        // Mise à jour de l'horloge toutes les secondes
        function updateTime() {
            var clock = document.getElementById("clock");
            var date = new Date();
            var hours = date.getHours();
            var minutes = date.getMinutes();
            var seconds = date.getSeconds();
            clock.innerHTML = addLeadingZero(hours) + ":" + addLeadingZero(minutes) + ":" + addLeadingZero(seconds);
            setTimeout(updateTime, 1000);
        }

        // Ajouter un zéro devant les chiffres < 10
        function addLeadingZero(number) {
            return (number < 10) ? "0" + number : number;
        }

        // Afficher une notification
        function showNotification(type, title, message) {
            var icon = "Olop.png";
            if (type === -1) {
                icon = "Warning.png";
            } else if (type === 0) {
                icon = "Info.png";
            } else if (type === 1) {
                icon = "Ok.png";
            }
            openWindow(icon, title, message, 1);

            var notificationBar = $('#notificationBar');
            var notificationCountElement = $('#notificationCount');

            notificationBar.hide();
            notificationCount++;
            notificationBar.css('display', 'block');
            notificationCountElement.text(notificationCount);
            notificationBar.fadeIn('slow');
        }

        // Ouvrir une nouvelle fenêtre
        function openWindow(icon, title, content, isnotif, id) {
    if (icon === "") {
        icon = "Olop.png";
    }

    var windowElement = createWindowElement(icon, title, content, isnotif, id);
    document.body.appendChild(windowElement);

    return windowElement; // Retourne l'élément de fenêtre créé
}

        // Créer un élément de fenêtre avec le titre et le contenu spécifiés
        function createWindowElement(icon, title, content, isnotif, id) {
            if (!id) {
        id = "window-" + Math.random().toString(36).substr(2, 9); // générer un ID seulement si aucun ID n'est passé
    }
    var idW = Math.random().toString(36).substr(2, 9);
    var windowElement = $('<div class="window" id="'+idW+'"></div>');
    var windowTitleBar = $('<div class="window-title-bar"></div>');
    var windowTitle = $('<span class="window-title"></span>');
    var iconImage = $('<img class="window-icon" src="' + icon + '">');
    var closeButton = $('<button type="button">&#10060;</button>').click(function() {
        if (isnotif === 1) {
            if (notificationCount === 1) {
                $("#notificationBar").fadeOut("slow");
                notificationCount = 0;
            } else {
                notificationCount--;
            }
            document.getElementById("notificationCount").innerText = notificationCount;
        }
        closeWindow(this);
    });
    
    // Ajouter la classe dark-theme à la fenêtre si le thème sombre est actif
    if (document.body.classList.contains('dark-theme')) {
        windowElement.addClass('dark-theme');
    }

    var windowContent;
    if(!id){ var windowContentId = generateUniqueIdForWC();// Vérifier si l'ID généré est unique, sinon en générer un nouveau
    while (windowContentIds.includes(windowContentId)) {
        windowContentId = generateUniqueIdForWC();
    }}else {
        var windowContentId = id;
    }
    
    windowContentIds.push(windowContentId); // Ajouter l'ID à la liste des IDs existants

    windowContent = $('<div class="window-content" id="' + windowContentId + '">' + content + '</div>');
    var minimizeButton = $('<button type="button" class="minimize-button">&#9473;</button>').click(function () {
        minimizeWindow(idW);
    });
    if (document.body.classList.contains('dark-theme')) {
        minimizeButton.addClass('dark-theme');
    }
    if (document.body.classList.contains('dark-theme')) {
        windowTitleBar.addClass('dark-theme');
    }

    windowTitle.append(iconImage).append(title);
    windowTitleBar.append(windowTitle).append("&nbsp;").append(minimizeButton).append('&nbsp;').append(closeButton);
    windowElement.append(windowTitleBar).append(windowContent);

    return windowElement.get(0);
}

function generateUniqueIdForWC() {
    return "window_content_" + Math.random().toString(36).substr(2, 9);
}

        function closeWindow(button, isdb) {
    if (isdb === 1) {
        // Si la fenêtre est minimisée, fermer et supprimer la fenêtre de la liste des fenêtres minimisées
        console.log('Close window and remove:', button.parentNode.parentNode.parentNode);
        button.parentNode.parentNode.parentNode.remove();

        var id = button.parentNode.parentNode.id;
        var index = minimizedWindows.indexOf(id);
        if (index !== -1) {
            minimizedWindows.splice(index, 1);
        }

    } else {
        console.log('Close window:', button.parentNode.parentNode);
        button.parentNode.parentNode.remove();
    }
}

        // Function to toggle window visibility between minimized and restored
        function minimizeWindow(windowId) {
  var windowElement = $('#' + windowId);

  if (minimizedWindows.includes(windowId)) {
    // Si la fenêtre est déjà minimisée, restaure-la
    var index = minimizedWindows.indexOf(windowId);
    minimizedWindows.splice(index, 1);
    windowElement.show();
  } else {
    // Sinon, minimise-la
    minimizedWindows.push(windowId);
    windowElement.hide();
  }

  // Mettre à jour le contenu du bouton "minimiser"
  updateMinimizedButton();
}

// Fonction pour afficher les fenêtres minimisées
function viewMinimizedWindows() {
    // Créez un nouvel élément div jQuery pour afficher la liste des fenêtres minimisées
    var windowList = $('<div>').addClass('window-list');

    for (var i = 0; i < minimizedWindows.length; i++) {
        var windowId = minimizedWindows[i];
        var windowElement = $('#' + windowId);

        var windowItem = $('<div>').addClass('window-item');
        var windowTitle = windowElement.find('.window-title').text();

        // Ajoutez un bouton de restauration pour chaque fenêtre minimisée
        var restoreButton = $('<button>').addClass('window-restore-button')
                                         .text('Restaurer')
                                         .attr('data-window-id', windowId);

        windowItem.text(windowTitle);
        windowItem.append(restoreButton);
        windowList.append(windowItem);
    }

    var windowListHTML = windowList.get(0).outerHTML;
    openWindow("", "Fenêtres minimisées", windowListHTML, 0);
    $(".window-list").on("click", ".window-restore-button", function() {
    var id = $(this).attr('data-window-id');
    var index = minimizedWindows.indexOf(id);
    minimizedWindows.splice(index, 1);
    $("#" + id).show();
    // Supprimer la liste des fenêtres minimisées après avoir restauré la fenêtre
    $('.window-list').parent().parent().remove();
    updateMinimizedButton(); 
});
}

async function closeMinimizedWindowList() {
    if (isMinimizedWindowListOpen && minimizedWindowListRef) {
        console.log('Close minimized window list:', minimizedWindowListRef.parentNode.parentNode);
        await minimizedWindowListRef.parentNode.parentNode.remove();
        isMinimizedWindowListOpen = false;
    }
}

        function decodeApp(data) {
            var lignesSeparate = data.split('\n').filter(Boolean);
            var result = [];

            var nom;
            var version;
            var url;
            var developpeur;
            var type;
            var os;
            var description;

            if (lignesSeparate.length >= 6) {
                nom = lignesSeparate[0];
                version = lignesSeparate[1];
                url = lignesSeparate[2];
                developpeur = lignesSeparate[3];
                type = lignesSeparate[4];
                os = lignesSeparate[5];

                // Si la description contient plusieurs lignes, les concaténer
                if (lignesSeparate.length > 6) {
                    description = lignesSeparate.slice(6).join("\n");
                }
            }

            result.push("", nom, version, url, developpeur, type, os, description);
            return result;
        }

        function updateMinimizedButton() {
  var minimizedInfo = $("#minimizedInfo");
  var viewMinimizedButton = $("#viewMinimized");

  var numMinimized = minimizedWindows.length;
  if (numMinimized > 0) {
    minimizedInfo.html("Vous avez " + numMinimized + " fenêtre(s) minimisée(s).");
    viewMinimizedButton.show();
  } else {
    minimizedInfo.html("");
    viewMinimizedButton.hide();
  }
}

        async function downloadFile(fileUrl) {
            try {
                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error('Erreur lors du téléchargement du fichier');
                }
                const data = await response.text();
                return data;
            } catch (error) {
                console.error('Une erreur s\'est produite :', error);
                showNotification(-1, 'Erreur de chargement du .app', error.message);
                return null;
            }
        }

        async function loadPAP(app) {
            try {
                const result = await downloadFile(`/getapp/${app}`);
                const decodedResult = decodeApp(result);
                const nom = decodedResult[1];
                const version = decodedResult[2];
                const url = decodedResult[3];
                const developpeur = decodedResult[4];
                const type = decodedResult[5];
                const os = decodedResult[6];
                const description = decodedResult[7];
                const iconurl = `${url}/favicon.png`;

                const regex = /\/([a-zA-Z0-9]{1,6})\.app$/;
                const match = app.match(regex);
                const appf = match ? match[1] : "";

                try {
                    const iconResult = await downloadFile(`/checkurl/200/${iconurl}`);
                    if (iconResult.indexOf("1") === -1) {
                        openWindow("/Olop.png", nom, getAppDescription(nom, version, developpeur, description, app));
                    } else {
                        openWindow(iconurl, nom, getAppDescription(nom, version, developpeur, description, app));
                    }
                } catch (error) {
                    openWindow("/Olop.png", nom, getAppDescription(nom, version, developpeur, description, app));
                }
            } catch (error) {
                // Gérer l'erreur de downloadFile("/getapp/")
            }
        }

        function getAppDescription(nom, version, developpeur, description, app) {
            return `${description}<div style='text-align: right;'><i>${nom} version ${version}, <br>développé par ${developpeur}</i><br><button type="button" class="button" onclick="closeWindow(this,1);">Annuler</button>&nbsp;<button type="button" class="button" onclick="Launch(this, '${app}');">Lancer</button></div><br>`;
        }

        function Launch(button, app) {
    $(button).parent().parent().load("/Launch/1/" + app + "-OLOP-" + $(button).parent().parent().attr("id"));
}

        function update() {
            $("#button-update").html("Recherche de mises à jour...")
            $("#info1").show("slide");
            $.ajax({
                url: "https://olopsytems.000webhostapp.com/Checkupdate.php?ver=alpha-1.1",
                data: { id: $(this).attr("id") },
                dataType: "text",
                success: function(recup) {
                    console.log(recup);
                    if (recup.indexOf("0") !== -1) {
                        $("#button-update").html("Aucune mise à jour disponible.<button onclick=\"mask(1);\">x</button>")
                    } else {
                        $("#button-update").html("Mise à jour disponible. Merci de la télécharger." /*, souhaitez-vous l'installer ? <button onClick=\"install();\">Oui</button><button onclick=\"mask(1);\">Non</button>"*/ );
                    }
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    $("#button-update").html("Une erreur est survenue lors de la vérification de mises à jours, veuillez vérifier votre connexion internet.<button onclick=\"update();\">Rééssayer</button><button onclick=\"mask(1);\">x</button>"); //Ce code affichera le message d'erreur, ici Message d'erreur.
                }
            });
        }

        function openSettings() {
    var id = "SETTINGS_" + Math.random().toString(36).substr(2, 9);
    openWindow("", "Paramètres", "Un instant...", 0, id);
    $("#" + id).load("settings.html");
}

        function toggleTheme(force) {
    var shouldToggle = true;
    if (force === 'dark' && !document.body.classList.contains('dark-theme')) {
        shouldToggle = true;
    } else if (force === 'light' && document.body.classList.contains('dark-theme')) {
        shouldToggle = true;
    } else if (force === 'toggle') {
        shouldToggle = true;
    } else {
        shouldToggle = false;
    }

    if (shouldToggle) {
        var body = document.body;
        var sidebar = document.getElementById('sidebar');
        var content = document.getElementById('content');
        var windows = Array.from(document.querySelectorAll('.window'));
        var titleBars = Array.from(document.querySelectorAll('.window-title-bar'));
        var buttons = Array.from(document.querySelectorAll('.button'));
        var clock = document.getElementById('clock');
        var toggleMenuBtn = document.getElementById('toggleMenuBtn');
        var links = Array.from(document.querySelectorAll("a"));

        // List of elements to toggle dark theme
        var elementsToToggle = [body, sidebar, content, clock, toggleMenuBtn];

        // Push windows and title bars into elements to toggle
        elementsToToggle.push(...windows, ...titleBars, ...buttons, ...links);

        // Toggle dark theme for each element
        elementsToToggle.forEach(element => {
            element.classList.toggle('dark-theme');
        });
    }
}

        document.addEventListener('DOMContentLoaded', function() {
            const observer = new MutationObserver((mutationsList) => {
    // Parcourir toutes les mutations qui ont eu lieu
    for (const mutation of mutationsList) {
        // Si le nœud ajouté est un élément
        if (mutation.type === 'childList' && mutation.addedNodes.length > 0 && document.body.classList.contains('dark-theme')) {
            mutation.addedNodes.forEach((node) => {
                if (node instanceof Element) { // vérifiez si le nœud est un élément
                    // Vérifiez si le nœud ajouté est un lien et ajoutez la classe dark-theme s'il y en a un
                    //if (node.nodeName === 'A') {
                        node.classList.add('dark-theme');
                   // }
                    // Si le nœud ajouté a des descendants de type lien, ajoutez leur classe dark-theme
                    const links = node.querySelectorAll('a');
                    links.forEach((link) => {
                        link.classList.add('dark-theme');
                    });
                }
            });
        }
    }
});

function updateTheme() {
if(themeMode===1){
    var currentHour = new Date().getHours();
    if (currentHour >= FirstTATheme || currentHour < secondTATheme) {
        toggleTheme('dark');
    } else {
        toggleTheme('light');
    }
}}

// Commencer à observer le document avec les configurations spécifiées
observer.observe(document.body, { childList: true, subtree: true });

setTimeout(() => {
    updateTheme();
setInterval(updateTheme, 60000); // Vérifie le thème chaque minute
    loadPage("home");
            updateTime();
            update();
            toggleMenu();
    
      // Masquer le loader
      var loader = document.getElementById('loader');
      loader.style.display = 'none';

}, 10);

  // Autres opérations...
});
    </script>
</head>
<body>
    <div id="sidebar" class="hidden">
        <h1>Olop</h1>
        <ul>
            <li onclick="loadPage('home')">Accueil</li>
            <li onclick="loadPage('Library')">Bibliothèque</li>
        </ul>
        <div id="info1">
            <div id="button-update"></div>
        </div><br>
        <div id="notificationBar" style="display: none;">
            Vous avez <span id="notificationCount"></span> notification(s).
        </div>
        <div id="minimizedInfo"></div>
        <button type="button" id="viewMinimized" style="display: none;" onclick="viewMinimizedWindows()">Voir</button>
        <a class="flat-button settings-link" href="#" onclick="openSettings();">&#9881; Paramètres</a>
    </div>

    <div id="content" class="content-shifted">
    </div>

    <div id="clock"></div>

    <div id="loader">
        <img src="Olop.png" alt="Loader">
    </div>

    <div id="toggleMenuBtn">
        <button type="button" onclick="toggleMenu()" class="menu-button">&#9776;</button>
    </div>
</body>
</html>